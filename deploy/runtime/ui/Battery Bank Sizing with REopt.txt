Battery Bank Sizing with REopt
994
397
20
GroupBox

1
8
Name
5
19
Battery Bank Sizing
X
3
6
Y
3
0
Width
3
985
Height
3
396
Tool Tip
5
0
Caption
5
19
Battery Bank Sizing
Bold
2
1
Numeric

1
17
Name
5
28
batt_C_rate_max_charge_input
X
3
843
Y
3
63
Width
3
90
Height
3
24
Tool Tip
5
0
Value
1
0
Mode
3
1
Format
3
1
Decimals
3
3
Prefix
5
0
Suffix
5
0
ThousandsSep
2
1
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
4294967295
Numeric

1
17
Name
5
31
batt_C_rate_max_discharge_input
X
3
843
Y
3
90
Width
3
90
Height
3
24
Tool Tip
5
0
Value
1
0
Mode
3
1
Format
3
1
Decimals
3
3
Prefix
5
0
Suffix
5
0
ThousandsSep
2
1
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
4294967295
Numeric

1
17
Name
5
24
batt_bank_ncells_serial1
X
3
591
Y
3
63
Width
3
90
Height
3
24
Tool Tip
5
0
Value
1
0
Mode
3
0
Format
3
1
Decimals
3
3
Prefix
5
0
Suffix
5
0
ThousandsSep
2
1
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
4
Numeric

1
17
Name
5
24
batt_bank_nseries_stacks
X
3
591
Y
3
117
Width
3
90
Height
3
24
Tool Tip
5
0
Value
1
0
Mode
3
0
Format
3
1
Decimals
3
3
Prefix
5
0
Suffix
5
0
ThousandsSep
2
1
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
5
Numeric

1
17
Name
5
18
batt_bank_nstrings
X
3
591
Y
3
90
Width
3
90
Height
3
24
Tool Tip
5
0
Value
1
0
Mode
3
0
Format
3
1
Decimals
3
3
Prefix
5
0
Suffix
5
0
ThousandsSep
2
1
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
5
Numeric

1
17
Name
5
15
batt_bank_power
X
3
174
Y
3
96
Width
3
90
Height
3
24
Tool Tip
5
0
Value
1
0
Mode
3
1
Format
3
1
Decimals
3
3
Prefix
5
0
Suffix
5
0
ThousandsSep
2
1
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
3
Choice

1
9
Name
5
21
batt_bank_power_dc_ac
X
3
330
Y
3
93
Width
3
54
Height
3
24
Tool Tip
5
0
Items
6
2
DC
AC
Selection
3
4294967295
TabOrder
3
4294967295
Numeric

1
17
Name
5
14
batt_bank_size
X
3
174
Y
3
69
Width
3
90
Height
3
24
Tool Tip
5
0
Value
1
0
Mode
3
1
Format
3
1
Decimals
3
3
Prefix
5
0
Suffix
5
0
ThousandsSep
2
1
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
2
Choice

1
9
Name
5
20
batt_bank_size_dc_ac
X
3
330
Y
3
69
Width
3
54
Height
3
24
Tool Tip
5
0
Items
6
2
DC
AC
Selection
3
4294967295
TabOrder
3
4294967295
Numeric

1
17
Name
5
22
batt_bank_size_specify
X
3
591
Y
3
144
Width
3
90
Height
3
24
Tool Tip
5
0
Value
1
0
Mode
3
1
Format
3
1
Decimals
3
3
Prefix
5
0
Suffix
5
0
ThousandsSep
2
1
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
2
Label

1
13
Name
5
19
batt_parallel_label
X
3
390
Y
3
90
Width
3
198
Height
3
24
Tool Tip
5
0
Caption
5
29
Number of strings in parallel
TextColour
4
0
0
0
255
Bold
2
0
FontSize
3
0
WordWrap
2
0
AlignRight
2
1
AlignTop
2
0
Label

1
13
Name
5
17
batt_series_label
X
3
396
Y
3
63
Width
3
192
Height
3
24
Tool Tip
5
0
Caption
5
25
Number of cells in series
TextColour
4
0
0
0
255
Bold
2
0
FontSize
3
0
WordWrap
2
0
AlignRight
2
1
AlignTop
2
0
RadioChoice

1
11
Name
5
16
batt_size_choice
X
3
57
Y
3
18
Width
3
714
Height
3
36
Tool Tip
5
0
Selection
3
0
Items
6
2
Specify desired bank size
Specify cells
ShowCaptions
2
1
Horizontal
2
1
TabOrder
3
1
Label

1
13
Name
5
15
batt_size_label
X
3
36
Y
3
138
Width
3
390
Height
3
81
Tool Tip
5
0
Caption
5
217
Bank capacity and power fields are values measured before conversion and parasitic losses.  If specified in AC, the DC/AC conversion efficiency will be used to scale the battery size.  See help for sizing information.
TextColour
4
0
0
0
255
Bold
2
0
FontSize
3
0
WordWrap
2
1
AlignRight
2
0
AlignTop
2
1
Label

1
13
Name
5
16
batt_size_label3
X
3
48
Y
3
255
Width
3
915
Height
3
60
Tool Tip
5
0
Caption
5
289
Use from the current case the lat/lon from Location and Resource, System Design parameters, subarray 1 Losses, System Costs, Electricity Rates and Electric Load settings to determine for the current PV system design the optimal battery power, capacity and dispatch from the REopt Lite API.
TextColour
4
0
0
0
255
Bold
2
0
FontSize
3
0
WordWrap
2
1
AlignRight
2
0
AlignTop
2
1
Button

1
8
Name
5
10
call_reopt
X
3
594
Y
3
351
Width
3
162
Height
3
24
Tool Tip
5
0
Caption
5
21
Get size and dispatch
TabOrder
3
4294967295
GroupBox

1
8
Name
5
8
object 4
X
3
33
Y
3
231
Width
3
942
Height
3
150
Tool Tip
5
0
Caption
5
38
Optimal Sizing and Dispatch from REopt
Bold
2
1
Label

1
13
Name
5
8
object 7
X
3
48
Y
3
318
Width
3
909
Height
3
30
Tool Tip
5
0
Caption
5
128
Note: ReOpt downloads its own weather file from the provided lat/lon and does not use the one provided in Location and Resource.
TextColour
4
0
0
0
255
Bold
2
0
FontSize
3
0
WordWrap
2
1
AlignRight
2
0
AlignTop
2
1
Numeric

1
17
Name
5
18
value_of_lost_load
X
3
315
Y
3
351
Width
3
90
Height
3
24
Tool Tip
5
0
Value
1
0
Mode
3
0
Format
3
1
Decimals
3
3
Prefix
5
0
Suffix
5
0
ThousandsSep
2
1
Editable
2
1
ForeColour
4
0
0
0
255
BackColour
4
255
255
255
255
TabOrder
3
4

12
batt_C_rate_max_charge_input
3
1
Max C-rate of charge
per/hour
Battery
0
2
1
1
1
1
0.5
Default
batt_C_rate_max_discharge_input
3
1
Max C-rate of discharge
per/hour
Battery
0
2
1
1
1
1
0.5
Default
batt_bank_ncells_serial
3
1
Number of cells in series
 
Battery
0
3
1
1
1
1
3
Default
batt_bank_nseries_stacks
3
1
Number of stacks in series
 
Battery
0
2
1
1
1
1
1
Numeric
batt_bank_nstrings
3
1
Number of strings in parallel
 
Battery
0
3
1
1
1
1
1
Default
batt_bank_power
3
1
Desired bank power
kW
Battery
0
2
1
1
1
1
20
Default
batt_bank_power_dc_ac
3
1
Battery power DC or AC input
 
Battery
0
1
1
1
1
1
0
Choice
batt_bank_size
3
1
Desired bank capacity
kWh
Battery
0
2
1
1
1
1
3
Default
batt_bank_size_dc_ac
3
1
Battery capacity DC or AC input
 
Battery
0
1
1
1
1
1
0
Choice
batt_bank_size_specify
3
1
Bank capacity
kWh
Battery
0
2
1
1
1
1
100
Numeric
batt_size_choice
3
1
Battery sizing option
 
Battery
39
Specify desired bank size|Specify cells
1
1
1
1
1
0
Default
value_of_lost_load
3
1
 Value of lost load during outage
 $/kWh
Battery
0
2
1
1
1
1
100
Numeric

0
3925
on_load{'Battery Bank Sizing with REopt'} = define()
{
	set_chemistry();
	set_bank_sizing();
	
	on_change{'batt_size_choice'};
	on_change{'batt_bank_size'};
	on_change{'batt_bank_power'};
	on_change{'bank_bank_size_specify'};
};
on_change{'batt_size_choice'} = define()
{
	set_bank_sizing();
	battsize_warning_check();
};
on_change{'batt_bank_size'} = define(){battsize_warning_check();};
on_change{'batt_bank_power'} = define(){battsize_warning_check();};
on_change{'batt_bank_size_specify'} = define(){battsize_warning_check();};

function set_bank_sizing()
{
	isauto = (value('batt_size_choice') == 0);
	isflow = is_flow();

	// auto-sizing
	enable('batt_bank_size', isauto);
	enable('batt_bank_power', isauto);
	enable('batt_bank_voltage', isauto);
	enable('batt_bank_size_dc_ac', isauto);
	enable('batt_bank_power_dc_ac', isauto);

	// manual specify
	show('batt_bank_size_specify', isflow);
	show('batt_C_rate_max_charge_input', !isflow);
	show('batt_C_rate_max_discharge_input', !isflow);

	enable('batt_bank_ncells_serial', !isauto);
	enable('batt_bank_nstrings', !isauto);
	enable('batt_bank_nseries_stacks', !isauto);

	if (isflow)
		enable('batt_bank_size_specify', !isauto);
	else
	{
		enable('batt_C_rate_max_charge_input', !isauto);
		enable('batt_C_rate_max_discharge_input', !isauto);
	}
}

on_change{'call_reopt'} = define(){
	if (!value('batt_dispatch_auto_can_gridcharge')){
		change = yesno("ReOpt dispatch requires battery can be charged" + 
		" from grid. Change setting?");
		if (change){
			value('batt_dispatch_auto_can_gridcharge', true);
			refresh();
		}
		else
			exit;
	}
	if (!value('batt_dispatch_auto_can_charge')){
		change = yesno("ReOpt dispatch requires battery can be charged" + 
		" from PV. Change setting?");
		if (change){
			value('batt_dispatch_auto_can_charge', true);
			refresh();
		}
		else
			exit;
	}

	// reset size to 0 to remove battery costs from total_installed_cost
	value("batt_bank_power", 0);
	value("batt_bank_size", 0); 

	reopt = reopt_size_battery();
	
	if (reopt.error){
		if (strlen(reopt.error) > 0){
			msgbox(reopt.error);
		}
		else{
			msgbox("ReOpt Lite API timed out. Please try again later.");
		}
		exit;
	}
	
	y = reopt.response;

	if (y.outputs == null || y.outputs.Scenario == null){
		msgbox("Error in ReOpt response. Try again later or another system design.");
		exit;
	}

	if (y.outputs.Scenario.status != "optimal"){
		msgbox(y.outputs.Scenario.status);
		exit;
	}

	pv = y.outputs.Scenario.Site.PV;
	batt = y.outputs.Scenario.Site.Storage;
	elec = y.outputs.Scenario.Site.ElectricTariff;

	if (batt.size_kw == null && batt.size_kwh == null){
		apply_str = "Apply results?\nOptimal capacity: " + to_string(0) + 
			"\nOptimal power: " + to_string(0) + "\nApply results?";
		apply = yesno(apply_str);
		if (apply){
			value('batt_bank_power', 0.0);
			value('batt_bank_size', 0.0);
		}
		exit;
	}

	apply_str = "Apply results?\nOptimal capacity: " + to_string(batt.size_kwh) + 
		"\nOptimal power: " + to_string(batt.size_kw) + "\nOverride " +
		"'Battery capacity', 'Battery power', and 'Custom Dispatch' with results?";
	apply = yesno(apply_str);
	if (!apply)
		exit;

	value('batt_bank_power', batt.size_kw);
	value('batt_bank_size', batt.size_kwh);
	value('batt_dispatch_auto_can_charge', 1);

	if (batt.size_kw == 0 && batt.size_kwh == 0)
		exit;

	batt_to_grid = null;
	if (batt.year_one_to_grid_series_kw)
		batt_to_grid = batt.year_one_to_grid_series_kw;
	batt_to_load = batt.year_one_to_load_series_kw;
	pv_charge = pv.year_one_to_battery_series_kw;
	grid_charge = elec.year_one_to_battery_series_kw;

	value('batt_dispatch_choice', 3);
	

	dispatch = alloc(8760);

	for (i=0; i<8760; i++){
		if (batt_to_grid){
			discharge = batt_to_grid[i] + batt_to_load[i];
		} else{
			discharge = batt_to_load[i];
		}
		charge = -pv_charge[i] - grid_charge[i];
		dispatch[i] = discharge + charge;
	}

	value('batt_custom_dispatch', dispatch);
};